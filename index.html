<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<style type="text/css">
		canvas{
			display: block;
		}
		img{
			display: none;
		}
		html{
			height: 100%;
		}
		body{
			height: 100%;
			display: flex;
			justify-content: center;
			align-items: center;
		}
	</style>
</head>
<body>
	<!-- 注意!!!双击文件无效,使用liveserver -->

	<!-- 改图片src -->
	<!-- 改canvas标签宽高 -->
	<!-- 改比例 5.4 -->
	<img src="onepeace.png" alt="" id="pic">
	<canvas width="900" height="300"></canvas>

	<script type="text/javascript">
		// 1 : 设置小球起点(初始状态)
		// 2 : 设置小球终点(设置小球的追踪状态)
		// 3 : 计算出起点到终点的差值
		// 4 : 计算出定时器每次运行小球变化量
		// ============================================================
		function Ball(targetX , targetY,w,h){
			// 0 : 设置小球半径
			// this.r = 2
			// 1 : 起始状态(也是小球每一帧的当前位置)
			// 0到800之间取一个随机数
			this.x = Math.random() * w;
			this.y = Math.random() * h;
			this.r = 2;
			this.color_o = 1
			
			// 2 : 最终状态
			this.targetX = targetX;
			this.targetY = targetY;
			this.targetR = 2;
			this.target_color_o = 0.7;

			// 3 : 距离,差值
			this.distanceX = this.targetX - this.x;
			this.distanceY = this.targetY - this.y;
			this.distanceR = this.targetR - this.r;
			this.distance_color_o = this.target_color_o - this.color_o;
			// 4 : 定时器每次执行的变化量
			// 已知,每20毫秒一帧 , 整个过程为2s(2000毫秒) , 那么这两秒里总共跳了2000/20 = 100幁 ,每次的变化量为==差值/100  
			this.dx = this.distanceX / 50;
			this.dy = this.distanceY / 50;
			this.dr = this.distanceR / 50;
			this.d_color_o = this.distance_color_o / 50;
		}
		// 1 : 如果到this.x和终点的距离小于this.dx,this.x就不改变了
		// 2 : 如果到this.y和终点的距离小于this.dy,this.y就不改变了
		// 3 : 绘制小球
		// =============================================================
		Ball.prototype.render = function(){
			// 1 : 如果到this.x和终点的距离小于this.dx,this.x就不改变了
			if(Math.abs(this.targetX-this.x)>Math.abs(this.dx)){
				this.x += this.dx;
				this.y += this.dy;
				this.r += this.dr;
				this.color_o += this.d_color_o;
			}
			
			// 3 : 绘制小球
			ctx.beginPath();
			ctx.globalAlpha=this.color_o
			let bb = "rgba(" + this.color_r + "," + this.color_g + "," + this.color_b + "," + this.color_o + ")"
			ctx.fillStyle = bb
			ctx.arc(this.x , this.y , this.r , 0 , 7 , false);
			ctx.fill();
		}
		// 1 : 获取画布
		// 2 : 创建画笔
		// 3 : 获取图片
		// 4 : 创建放小球的list
		// 	   存放小球数据的list	
		// 5 : 等待图片加载完成后
		// 	 5.1 : 在画布里面画出图片
		// 	 5.2 : 获取出图片的数据
		// 	 5.3 : 提取出需要的数据
		// 	 5.4 : 用提取出的数据创造小球并放入ballarr数组里面
		// 6 : 启动定时器,小球开始渲染
		// =============================================================
		// 1 : 获取画布
		var canvas = document.querySelector("canvas");
		// 2 : 创建画笔
		var ctx = canvas.getContext("2d");
		let canvas_h = canvas.height
		let canvas_w = canvas.width
		// 3 : 获取图片
		var pic = document.getElementById('pic')
		// 4 : 创建放小球的list
		// 	   存放小球数据的list
		var ballarr = [];
		var arr = [];	
		// 5 : 等待图片加载完成后
		pic.onload = function(){
			// 5.1 : 在画布里面画出图片
			ctx.drawImage(pic, 0,0);  
			// 5.2 : 获取出图片的数据
			var imagedata = ctx.getImageData(0, 0, canvas_w, canvas_h);	
			// imagedata.data是一个长度为400*400*4的list组成
			// 400*400表示宽400个像素点,高400个像素点,
			// 一个像素点由4个数字组成,分别表示rgb和透明度
			// 例如 : 
			// 		画布宽2像素,高2像素
			// 		imagedata.data = [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0,]
			// 					      ↓ ↓ ↓ ↓  ↓ ↓ ↓ ↓  ↓ ↓ ↓ ↓  ↓ ↓ ↓ ↓ 
			//					      r,g,b,o, r,g,b,o, r,g,b,o, r,g,b,o,
			// 						  (1,1)点  (1,2)点  (2,1)点  (2,2)点   
			
			// 5.3 : 提取出需要的数据
			for(var i = 3 ; i < imagedata.data.length ; i+=4){
				// 如果透明度不为0就提取出来
				if(imagedata.data[i] != 0){
					// 获取透明度不为0的点的x坐标 : (i-3)/4%400
					// 获取点的y坐标 : Math.ceil(i/(400*4))
					let n = (i-3)/4
					arr.push({"x" : n % canvas_w , "y" : Math.ceil(n/canvas_w)});
				}
			}


			// arr.forEach(function(item){
			// 	ctx.beginPath();
			// 	ctx.arc(item.x , item.y , 0.3 , 0 , 7 , false);
			// 	ctx.fill();
			// });

			// 5.4 : 用提取出的数据创造小球并放入ballarr数组里面
			arr.forEach(function(item){
				// item.x*4 : 比例放大4倍
				// +后面的是位移
				ballarr.push(new Ball(item.x*3 , item.y*3 , canvas_w, canvas_h));
			});

		}
		// 6 : 启动定时器,小球开始渲染	
		setInterval(function(){
			//清屏
			ctx.clearRect(0, 0, canvas_w, canvas_h);
			ballarr.forEach(function(item){
				item.render();
			});
		},20);

	</script>
</body>
</html>